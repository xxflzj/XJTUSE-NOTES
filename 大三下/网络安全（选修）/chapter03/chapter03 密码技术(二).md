[TOC]

# [XJTU计算机网络安全与管理]第三讲 密码技术[二]

## KEY POINTS

**现代块加密技术**是最为广泛使用的加密算法中的一种

能够提供**数据机密性与鉴别服务**(CIAAA中的真实性)

我们将主要研究对象集中于DES (Data Encryption Standard)，通过其了解块加密的相关设计原则

## 一、块加密(分组加密)

### 块加密vs流加密

:one: **块加密（block ciphers）**将消息处理为块，然后单独进行加/解密运算

> 过程似乎是**对一个个特大字符的替换**：64-bits 或更多
>
> 许多现有的密码都属于块加密
>
> 具有广泛的应用

:two: **流加密（stream ciphers）**将消息**按照位或字节为单位进行加/解密**——<mark>密钥不能重复使用</mark>

![image-20220601165336940](https://note-image-1307786938.cos.ap-beijing.myqcloud.com/typora/image-20220601165336940.png)

### 块加密的设计准则

绝大多数的块加密技术均基于**Feistel Cipher Structure**

源于对消息加解密效率的需求

块加密类似于极端情况下的替换

以64-bits的块为例则其表项将达到$2^{64}$

替代了较小的构建块

利用了乘积密码的概念

### Feistel密码结构的设计动机

<font color="red">不是理想的块加密</font>

分组密码作用于n位明文分组，产生n位密文分组。由可逆性不同的变化数为(2^n^)!个

<img src="https://note-image-1307786938.cos.ap-beijing.myqcloud.com/typora/image-20220601165817713.png" alt="image-20220601165817713" style="zoom:67%;" />

![image-20220601165932128](https://note-image-1307786938.cos.ap-beijing.myqcloud.com/typora/image-20220601165932128.png)

图示为n=4时分组密码所对应的加密表，用这样的方式密钥长度为4x16=64位(16个状态x4位）。对于n位密钥规模nx2^n^。为了实现方便，我们通常只讨论2^n^!

### Claude Shannon and Substitution-Permutation Ciphers

Claude Shannon 1949年在其论文中介绍了Substitution-Permutation（S-P）的概念，构成了现代块加密的基础

S-P网络基于两个密码学原语操作——<mark>记住</mark>

> `substitution (S-box)`替代
>
> `permutation (P-box)`置换

提供了对消息的**混淆与扩散——<mark>记住</mark>**

#### 混淆与扩散Confusion and Diffusion

密码需要能够**隐蔽源消息的统计特性**

一次一密（one-time pad）做的正是这点

在实践上，Shannon建议组合S&P元素以达到：

> 扩散：将明文的统计结构扩散到密文的长程统计特征中
>
> 混淆：使密文与密钥的联系尽可能的复杂

### Feistel密码

对香农思想的实现

通过交替使用代替与置换构造乘积密码逼近理想密码。

#### Feistel密码结构

![image-20220601170617017](https://note-image-1307786938.cos.ap-beijing.myqcloud.com/typora/image-20220601170617017.png)

Horst Feistel设计了feistel 密码：基于可逆乘积码

将数据块分为两部分：左半边和右半边

> :one: 处理由多轮构成
>
> :two: 每轮中对数据的左一半进行替代操作，方法是将数据的右一半结合子密钥应用round函数F，然后将这个函数的输出与左边一半做异或。
>
> :two: 然后将左右两部分进行置换（左变右，右变左）
>

实现了Shannon的S-P网络概念

本质是开发一个分组密码密钥长度为k位，分组长度n位。采用$2^k$种变化，而不是理想分组的($2^n$)!

#### Feistel解密算法

**Feistel解密算法**：Feistel密码的解密过程本质上与加密过程一致。

输入的轮密钥Ki是由主密钥K推断出来的

其规则如下：将密文作为算法的输入，但是逆序使用子密钥K。也就是说。第一轮使用K~n~,第二轮使用K~n-1~,直到最后一轮使用K1。不需要分别实现加密和解密两个算法。

![image-20220601171015514](https://note-image-1307786938.cos.ap-beijing.myqcloud.com/typora/image-20220601171015514.png)

#### Feistel码的设计要素

:one: **分组大小**：分组越大，安全性越高（其他条件不变），但同时更慢。64-bit是一个折中

:two: **密钥大小**：密钥长度越长则安全性越高，但加解密速度也越慢。目前倾向于128-bit

:three: **循环次数**：feistel密码特点是一个循环不足以保证足够的安全性。次数越多越安全。一般用**16次**

:four: **子密钥生成算法**：应足够复杂

:five: **Round函数**（F函数）：应足够复杂

:six: **加解密速度**：应足够快以适应应用

:seven: **易于分析**(DES并不满足)

## 二、数据加密标准——Data Encryption Standard (DES)

DEA：算法	DES：标准

2001年AES前最为广泛使用的块加密方案

1977年被以前的美国标准局（NBS），现在的美国标准与技术协会（NIST）所采用作为联邦信息处理标准采用

利用<mark>**56-bit密钥加密64bit块数据**</mark>——考点

被广泛应用特别是**金融领域**。1994年，NIST延长使用期5年。1999年颁布新标准只用于遗留系统与3DES；其安全性曾受到争议

### 发展历史

IBM开发了Lucifer密码

> 由Feistel领导的小组与上世纪60年代开发
>
> 使用64bit数据块，128-bit密钥
>

在NSA参与下进行了商业重开发

IBM最后提供的被接受的方案是DES

### DES加密过程

首先64-bit的明文进行初始IP置换

16次循环函数本身同时具有置换与替代函数。最后一轮输出后，将左右交换，在经过IP的逆置换可得

![image-20220601200030846](https://note-image-1307786938.cos.ap-beijing.myqcloud.com/typora/image-20220601200030846.png)

#### 初始置换Initial Permutation ——IP

数据计算的第一步；记录输入数据位；最终偶数位在左半边，奇数位在右半边

结构相当规则

例： IP(675a6967 5e5a6b5a) = (ffb2194d 004df6fb) 

注意：des的编号来源自IBM惯例，最左边的是第一位R_{}

#### 轮结构——比较重要

**轮密钥48位——考点**

每一轮的左边是上一轮的右边，每一轮的右边是上一轮的左边变换以后得到的。

记住：<mark>密钥长度56位，子密钥K~i~长度48位</mark>

采用两个 32-bit L & R 半组

对于任意的Feistel分组码都可以表示为:
$$
L_i=R_{i-1}\\
R_i=L_{i-1}\oplus F(R_{i-1},K_i)
$$
F 处理 32-bit R 半组 与48-bit子密钥:

> 通过E将 R 扩展为 <mark>**48-bits**</mark>(有重复的)
>
> 将其与子密钥进行 XOR相加
>
> 经过 8个 S-boxes得到32-bit的结果
>
> 通过 32-bit 置换 P改变次序

![image-20220601173405721](https://note-image-1307786938.cos.ap-beijing.myqcloud.com/typora/image-20220601173405721.png)

**S-盒**

8个 S-boxes将<mark> **6 bit映射为4 bits** </mark>——<mark>0~15</mark>（不会超过15！）

每个 S-box实际上是 4 个小的4 bit boxes 

> 外bits 1 & 6 (**row** bits) 选择四行里的行号 
>
> 结合内 bits 2-5 (**col** bits) 得到替代
>
> 结果是 8个 4 bits, 或者说是 32 bits

![image-20220601195215736](https://note-image-1307786938.cos.ap-beijing.myqcloud.com/typora/image-20220601195215736.png)

<mark>查表要掌握</mark>

> 输入000001
>
> 第一个bit0和最后一个bit1构成01——行号（1）
>
> 中间四位0000——列号（0）
>
> 输出0——0000

#### 密钥的生成

构成每轮中使用的子密钥，通过初始化置换（PC-1）将56bit分成两个28bit

16个阶段

> 每个阶段左右分别经过左移调度生成新的左右两端(每轮依据移动位数表左移1或2位)
>
> 将新的左右两端依据子密钥置换表（PC-2）再一次进行排列并取前面48位

### DES解密

解密同样需要将数据展开计算

根据Feistel设计, 按照加密的逆序使用子密钥 (SK16 … SK1)

> :one: IP 撤销加密过程中 FP 的影响 
>
> :two: 1 轮 利用SK16取消第16次加密轮的影响
>
> …
>
> :three: 16轮 利用 SK1 撤销第一轮的影响
>
> :four: 最后 FP 撤销 IP影响 
>
> :five: 最终得到解密结果

## 三、DES举例

考虑如下示例：

![image-20220601200304154](https://note-image-1307786938.cos.ap-beijing.myqcloud.com/typora/image-20220601200304154.png)

下表显示了算法的过程。第一行是经过初始置换后数据的左右两边的32位值。下面的16行显示的是各轮运行后的结果。表中也显示了各轮的48位子密钥。注意$L_i=R_{i-1}$。最后一行显示的是经过逆初始置换后左边和右边的值。这两个值组合起来形成密文。

![image-20220601200413547](https://note-image-1307786938.cos.ap-beijing.myqcloud.com/typora/image-20220601200413547.png)

### 雪崩效应

DES具备较好的雪崩效应

**改变一个bit的输入或密钥会使得密文的输出位出现很多位的变化**

## 四、DES的强度

尽管DES标准是公开的，但对其设计上存在很大分歧

> 56-bit（原先是128-bit）
>
> 其设计标准是保密的——比如八个S盒的设计思路无法得知

其后的应用效果与分析表明设计是可接受的

![image-20220601200625130](https://note-image-1307786938.cos.ap-beijing.myqcloud.com/typora/image-20220601200625130.png)

计时攻击（考察算法对于不同输入花费时间的差异的攻击思路，目前只是一种有趣的路线）

DES有许多替代算法：AES和3DES

## 五、DES的分析——不用看了

目前有几种分析攻击的方法针对DES

它们应用到了一些深层的密码结构

> 收集加密信息
>
> 可以恢复部分/所有子密钥
>
> 如果必要剩下的可以暴力破解

一般来说有如下方法

> 差分分析
>
> 线性分析
>
> 相关密钥攻击

### 设计准则

7 条 S-boxes 准则的以达到：非线性；抗差分分析；良好的混淆

3 条准则给 P 以达到：增加扩散性

**块加密准则**

> 基本的如同Feistel
>
> 轮数：越多越好
>
> F：提供混淆，非线性，雪崩
>
> Key：密钥雪崩，子密钥生成算法复杂

## 六、多重加密和三重DES

DES在穷举攻击下比较脆弱。因此很多人希望能够替代它

双重DES

> <mark>对应的映射不能简单地用单重加密来确定</mark>——判断
>
> 加密两次$E_{k1}E_{k2}(P)$：是否存在$E_{k3}$使得$E_{k3}(P)=E_{k1}E_{k2}(P)$?不是一回事
>
> 中间相遇攻击使得攻击的难度**仅仅略大于**单重DES

**三重DES：3DES/TDES/TDEAT/Triple DEA**

> NIST在1999年颁布了3des作为des的改进
>
> 3des的运算有两种即EDE($E_{k1}D_{k2}E_{k3}(P)$)或EEE模式($E_{k1}E_{k2}E_{k3}(P)$)
>
> 其中3可以是相同或不同的
>
> > K1≠K2≠K3 密钥长度为168位(56X3)
> >
> > K1≠K2，K3=K1，密钥长度为112位(56X2)
> >
> > K1=K2=K3,与一次DES运算兼容

## 七、离散数学知识

### 群

一个元素的集合

对于定义的运算封闭

遵从

> 结合律： (a.b).c = a.(b.c) 
>
> 有单位元e： e.a = a.e = a 
>
> 有逆元： a-1: a.a-1 = e

如果还遵从交换律： a.b = b.a 则我们称该群为阿贝尔群（交换群） **abelian group**

### 循环群

定义幂运算为群上运算的重复叠加

> 例： $a^3 = a.a.a$

且有单位元e=a0

我们说一个群是循环的就是指对该群中的任意元素均可表示为某一固定元素的幂

> $ie b = a^k$ 对某个 a 与与任意一个 b在群中。

其中a称为该群的生成元

### 环

集合上定义了两种操作（乘和加）

对于加法运算是一个阿贝尔群

对于乘法运算有

> 是封闭的
>
> 满足结合律
>
> 具有对加运算符合分配率： a(b+c) = ab + ac

若对乘法具有可交换性则称为**交换环**

若对乘法运算有单位元但无零因子，则称为**整环**

### 域

域作为定义了两中运算的集合具有

> 对于加法是阿贝尔群
>
> 对于乘法是阿贝尔群（忽略0）
>
> 是一个环

### 模运算

定义“a mod n”表示用n去除a得到的余数

用“a=b mod n”表示a与b模n具有相同的余数

对于一个数a通常可以表示为a=qn+r：称r为余数（余数通常取最小的正数）
$$
[(a \mod ⁡n)+(b \mod⁡n)]\mod⁡n=(a+b)\mod ⁡n\\
[(a \mod ⁡n)-(b \mod⁡n)]\mod⁡n=(a-b)\mod⁡ n\\
[(a \mod ⁡n)×(b \mod⁡n)]\mod⁡n=(a×b)\mod⁡ n
$$

### 最大公约数gcd

GCD (a,b)表示能同时整除a与b的数中最大的一个

当除1外不存在其它公因式时称作互质

**欧几里得算法**

```java
static int gcd(int number1, int number2) {
		return number1 % number2 == 0 ? number2 : gcd(number2, number1 % number2);
}
```

### 伽罗华域(有限域)——Galois Fields<重点>

有限域理论在密码学中具有重要作用

**元素数为某一个素数的n次方**

这样的域被称为有限域（迦罗华域）

记为GF(p^n^)

经常用到的有：<mark>GF(p)、GF(2^n^)</mark>

许多密码算法依赖于有限域的性质。特别是AES和椭圆曲线加密算法。我们离散数学中所学过的代数结构有这样的关系

<mark>意义</mark>——封闭性

#### GF(p)

GF(p) 是 {0,1, … , p-1}的集合，其上定义了模p的算术运算

构成了一个有限域：因为乘法运算有逆元($元素\times 该元素的逆\mod p = 1$)

其上可以进行加减乘除运算

例如：GF(7)

| $\times$ |  0   |   1   |   2   |   3   |   4   |   5   |  6   |
| :------: | :--: | :---: | :---: | :---: | :---: | :---: | :--: |
|    0     |  0   |   0   |   0   |   0   |   0   |   0   |  0   |
|    1     |  0   | **1** |   2   |   3   |   4   |   5   |  6   |
|    2     |  0   |   2   |   4   |   6   | **1** |   3   |  5   |
|    3     |  0   |   3   |   6   |   2   |   5   | **1** |  4   |
|    4     |  0   |   4   | **1** |   5   |   2   |   6   |  3   |
|    5     |  0   |   5   |   3   | **1** |   6   |   4   |  2   |
|    6     |  0   |   6   |   5   |   4   |   3   |   2   |  1   |

#### 寻找逆元——了解

使用扩展的欧几里得算法

<img src="https://note-image-1307786938.cos.ap-beijing.myqcloud.com/typora/image-20220426104901072.png" alt="image-20220426104901072" style="zoom:67%;float:left" />

### 多项式算数

可以使用多项式运算 

$f(x) = a_nx^n + a_{n-1}x^{n-1} + … + a_1x + a_0 = ∑ a_ix^i$

> 并不关心 x的值
>
> x作为不确定的值

可以有若干可变的选择

> 原始多项式运算
>
> mod p多项式运算
>
> mod p 与 mod m(x)多项式运算

可以有加减乘

> 取$f(x) = x^3 + x^2 + 2\quad  g(x) = x^2 – x + 1$
>
> $f(x) + g(x) = x^3 + 2x^2 – x + 3$
>
> $f(x) – g(x) = x^3 + x + 1$
>
> $f(x) \times g(x) = x^5 + 3x^2 – 2x + 2$

#### 模系数的多项式运算

在计算系数的时候模某个值：构成一个多项式环

可以模任意的素数

更为关心的是 <mark>**mod 2的运算**</mark>：所有的系数为 0 或 1

<font color="red">加法等价于异或，乘法等价于逻辑与，加法与减法是等价的</font>

> 1+1=1-1=0
>
> 1+0=1-0=1
>
> 0+1=0-1=1
>
> 一位数的模2乘法定义如下：
>
> 0×0=0
>
> 0×1=0
>
> 1×0=0
>
> 1×1=1
>
> 多位数的模2乘法与普通乘法一样演算,如：
>
> ![image-20220601210742590](https://note-image-1307786938.cos.ap-beijing.myqcloud.com/typora/image-20220601210742590.png)
>
> 唯一的区别是，部分积相加时按模2加，即奇数个1相加得1，偶数个1相加得0。

> $f(x) = x^3 + x^2 \quad g(x) = x^2 + x + 1$
>
> $f(x) + g(x) = x^3 + x + 1$
>
> $f(x) \times g(x) = x^5 + x^2$

#### 多项式除法

可以把任意多项式写成如下形式:

> $f(x) = q(x) g(x) + r(x)$
>
> 可以把 r(x) 作为一个余项
>
> $r(x) = f(x) \mod g(x)$

> 模2除法具有下列三个性质：
>
> 1、当最后余数的位数小于除数位数时，除法停止。
>
> 2、当被除数的位数小于除数位数时，则商数为0，被除数就是余数。
>
> 3、只要被除数或部分余数的位数与除数一样多，且最高位为1，不管其他位是什么数，皆可商1。

如果没有余项说 *g*(*x*) 整除 *f*(*x*)

**如果 *g*(*x*) 没有除了 1和它自身以外的因子 则称其为不可归约多项式或（素）多项式**

**算数模和不可约多项式构成了一个域**

![image-20220601204625045](https://note-image-1307786938.cos.ap-beijing.myqcloud.com/typora/image-20220601204625045.png)

#### 多项式最大公约数

可以通过欧几里得算法求出:

```c
EUCLID[a(x), b(x)]
	1、A(x) = a(x); B(x) = b(x)
	2、if B(x) = 0 return A(x) = gcd[a(x), b(x)]
	3、R(x) = A(x) mod B(x)
	4、A(x) ¨ B(x)
	5、B(x) ¨ R(x)
	6、goto 2
```

#### 模多项式算数

可以在域 GF(2^n^)中运算 

> 多项式系数都模 2
>
> 次数小于 n
>
> 因此需要利用一个**次数为n的不可归约多项式**为模进行简化 (仅对乘运算)

构成一个有限域

总能找到相应的逆元

可以利用扩展的欧几里得求逆算法寻找

### GF(2^3^)为例

为了构造有限域GF(2^3^),需要选择一个3次既约多项式。只有两个满足条件的多项式：x^3^+x^2^+1和x^3^+x+1。若选择后者，则GF(2^3^)上的加法和乘法表如表所示。从表容易读出加法和乘法。例如，考虑式子100+010=110。这等价于x^2^+x。再考虑100×010=011这等价于$x^2\times x=x^3$,约减后为x+1,即$x^3\mod(x^3+x+1)=x+1$等价于011。

![image-20220601205925176](https://note-image-1307786938.cos.ap-beijing.myqcloud.com/typora/image-20220601205925176.png)

![image-20220601205938723](https://note-image-1307786938.cos.ap-beijing.myqcloud.com/typora/image-20220601205938723.png)

## 参考资料

[1] 西安交通大学计算机网络安全与管理2022年春PPT 	田暄

[2] 密码编码学与网络安全（第七版），William Stallings著，王后珍等译