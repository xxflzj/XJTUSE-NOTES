[TOC]

# 第十七章 并行处理

## Key Points

> Taxonomy of parallel processor architecture
>
> SMP
>
> > •Characteristics
> > •Organization modes
> > •OS
>
> Clusters
>
> > •Configurations
> > •Applications
> > •OS 
>
> NUMA
>
> > •Organization
> > •Memory access 

> **1、并行处理机系统的FLYMM分类以及各自的代表**
>
> **2、对于MIMD中又分为紧耦合和松耦合，依据是什么，组织上有什么不同**
>
> **3、SMP对称多处理机系统的特征、优点、内部互联组织有哪些形式、上课补充的三种：总线、多端口内存、中央控制器和内部网络，各自优缺点是什么**
>
> **4、SMP多机系统中，保证cache一致性的解决方案，软件以及硬件的，硬件中又有两种，如何处理。分布式目录协议有两种处理方法，写无效和写更新，各自的含义是什么，MESI属于哪一类**
>
> **5、SMP设计时需要考虑哪些问题**
>
> **6、集群系统的特征、优点、分类、轻量级应用中的典型组织**
>
> **7、NUMA比起SMP和cluster有什么优势，典型组织CC-NUMA是怎样的，典型应用和组织，各个处理器如何进行内存访问，如何保持cache一致性，是与非**
>
> **8、以上三种并行机系统要对比学习**

## 17.1 多处理器组织

对具有并行处理能力的系统进行分类的方法如下：

:o: **单指令单数据（SISD）流**：单一处理器执行单一指令流来操作保存于单一存储器上的数据。单处理器系统属于这一类。

> 流水线和超级流水线都是SISD，超标量不是

![image-20211201112729421](https://note-image-1307786938.cos.ap-beijing.myqcloud.com/typora/qshell/image-20211201112729421.png)![image-20211201112918660](https://note-image-1307786938.cos.ap-beijing.myqcloud.com/typora/qshell/image-20211201112918660.png)

:o: **单指令多数据（SIMD）流**：一条机器指令控制几个处理部件基于锁步方式同时执行，每个处理部件有一个相关的数据存储器，故每条指令在不同的数据组上执行。17.7 节讨论的向量和阵列处理器属于这一类。

> 不同的数据处理相同的操作

![image-20211201112750754](https://note-image-1307786938.cos.ap-beijing.myqcloud.com/typora/qshell/image-20211201112750754.png)

:o: **多指令单数据（MISD）流**：一系列数据被发送到一组处理器，每个处理器执行不同的指令序列。这种结构从来没有在商业上被实现过。

<img src="https://note-image-1307786938.cos.ap-beijing.myqcloud.com/typora/qshell/image-20211201112822380.png" alt="image-20211201112822380" style="zoom:67%;" />

:o: **多指令多数据（MIMD）流**：**一组处理器同时执行不同的指令序列，对不同的数据集进行操作**。SMP、集群系统和NUMA系统都属于这一类。

> 例如超标量
>
> NUMA：紧耦合	松耦合：集群系统

<img src="https://note-image-1307786938.cos.ap-beijing.myqcloud.com/typora/qshell/image-20211201113209167.png" alt="image-20211201113209167" style="zoom:50%;" />



![image-20211201112520208](https://note-image-1307786938.cos.ap-beijing.myqcloud.com/typora/qshell/image-20211201112520208.png)

## 17.2 对称多处理器Symmetric Multiprocessors

对于SMP，具有如下的特征

> :one: 有**两个或更多功能相似的处理器**。
>
> :two: 这些处理器**共享同一主存**和 I/O设备，以总线或其他内部连接机制互连在一起；这样，存储器的存取时间对每个处理器大致都是相同的。
> 
>:three: 所有处理器共享对 1/0 设备的访问，或通过同一通道，或通过提供到同一设备路径的
> 不同通道。
> 
>:four: **所有处理器能完成同样的功能**（术语“对称”的由来）。
> 
>:five: 系统被一个**集中式操作系统（OS）**控制，OS提供各处理器及其程序之间的作业级、任务级、文件级和数据元素级的交互。
> 
> > 表示了与集群系统之类的松耦合多处理系统的对照。后者所交互操作的物理单位通常是消息或整个文件；而 SMP 中，各个的数据元素能成为一个交互级别，于是处理器间能够有高度的相互协作

SMP的操作系统可以跨越所有处理器来调度进程或线程，具有如下几个潜在优点

> **性能（performance）**：如果可以对一台计算机完成的工作进行组织，使得某些工作部分能够**并行完成**，则具有多个处理器的系统与具有同样类型的单处理器的系统相比，将产生更高的性能
> 
> **可用性（availability）**：在一个对称多处理器中，所有处理器都能完成同样的功能，故单个处理器的故障不会造成系统的停机，系统可在性能降低的情况下继续运行。
>
> **增量式增长（incremental growth）**：用户可以通过在系统中添加处理器来提高系统性能。原厂CPU最好
> 
>**可扩展（scaling）**：厂商能提供一个产品范围，它们基于系统中配置的处理器数目不同而有不同的价格和性能特征。

![image-20211201115312397](https://note-image-1307786938.cos.ap-beijing.myqcloud.com/typora/qshell/image-20211201115312397.png)

### 组织

#### 分时共享总线

对个人计算机、工作站、服务器而言，最普通的组织是分时共享总线

**优点**

> **简易性**
>
> 每个物理接口以及处理器的寻址、仲裁和分时特性都和单处理器系统相同
>
> **灵活性**
>
> 扩充系统很容易
>
> **可靠性**
>
> 总线上任一CPU的故障不会引起整个系统的瘫痪

**缺点**

> 系统性能受限于总线周期时间
>
> 为了减少总线访问，每个处理器都配置局部Cache，但又会带来Cache数据一致性的问题
>
> 总体来看使用两级Cache的好处还是要大于维护数据一致性的损失

#### 多端口内存

分为内存模块

每个处理器或I/O模块直接、独立地访问内存模块，几乎不需要修改处理器或I/O模块，但是需要逻辑去解决冲突

<img src="https://note-image-1307786938.cos.ap-beijing.myqcloud.com/typora/qshell/image-20211203101914901.png" alt="image-20211203101914901" style="zoom:50%;" />

对于CPU在不同端口的优先级的设置一般也不同，否则会使各个CPU的地位不均等

**优点**

> 每个处理器都有每个模块的专用路径 
> 可以将内存部分配置为一个或多个处理器专用 
> 提高了安全性，不容易被其他处理器修改

**缺点**

> 更复杂的控制，会造成内存系统中的额外逻辑 
>  应使用通过缓存写入策略进行缓存控制，处理器之间的通信仅通过内存进行

### SMP操作系统设计考虑

SMP 操作系统提供进程并发系统的所有功能和功能，以适应多个处理器，关键的设计问题如下：

> **同时并发进程**simultaneous concurrent process：允许几个处理器可同时执行同一OS代码
>
> **调度**scheduling
>
> **同步**synchronization
>
> **存储管理**memory management：多端口存储器；协调不同处理器上的分页机制；在页替换时决定合适的操作
>
> **可靠性和容错**reliability and fault tolerant：识别处理器的失效，并相应地重构管理表

## 17.3 cache一致性与解决方案

Cache一致性问题cache coherence：由于主存中同一数据的多个副本被存放在不同CPU的局部Cache中，如果让各CPU自由修改局部Cache的数据，就会导致各Cache之间及Cache和主存数据不一致的问题

在多机系统中，回写法肯定会导致数据的不一致

在多机系统中，写直达也会出现数据不一致的问题，除非其他Cache监听主存的访问情况

### 解决方案

#### 软件解决方案

依赖于编译程序和操作系统

基于编译程序的一致性机制完成代码分析，然后确定哪些数据对于Cache来说是不安全的

接着编译程序对这些数据项进行标注，避免把这些不安全数据放到局部Cache中去，规定这些数据只能在主存中进行存取

然后操作系统或硬件机制负责防止这些数据被用于Cache

**优点**

> 维护一致性开销由运行时间变成编译时间
>
> 设计复杂性由硬件转移到软件

**缺点**

> Cache利用率还是会下降
>
> 对于编写编译器和操作系统的程序员要求比较高

#### 硬件解决方案

采用一个目录来记录共享数据信息，有Cache修改需求的时候要先报送给目录，并发广播，收到其他Cache确认后才可以修改

**集中式目录协议（目录协议）**

> 基本思想就是不管有多少个CPU和局部Cache，系统都只维护一个目录，存放到专门的Cache或者是主存里去，这个目录记录并维护共享数据的副本存放在哪个局部Cache中的信息

**分布式目录协议（监听协议）**

> 其思想就是将维护Cache一致性的任务分散到各个Cache控制器
>
> 这些局部Cache必须能够识别它里面的数据行是否共享的
>
> 此协议不允许两个Cache直接通信，Cache数据交互必须要通过主存来完成，也不允许某个CPU对自己Cache中无效数据直接进行改写

**基于写无效的监听协议**

> 当某个CPU要对自己Cache的数据进行修改的时，通知其他还存有此数据的Cache将此行变为无效，并把这个行变为自己Cache所专有
>
> <font color="red">**MESI协议**</font>

**基于写更新的监听协议**

> 当一个处理器想要修改某个共享行，它也先要把这个具体想修改的行广播给其他Cache，然后其他包含此行的Cache跟着**发起修改CPU同时进行自己数据的修改**

## 17.4 集群

集群（Cluster）系统是由很多的独立计算机通过互联网或者是其他专用网络连接而成，它们之间可以协同工作，并对外表现为一个统一的集中的计算机资源，来供并行任务处理使用

**物理上有若干台机器，逻辑上只有一台**

> 可以替换SMP
>
> 性能较高
>
> 高可用性
>
> 适用于**高性能计算**
>
> 是一组互连的**整台计算机**
>
> 作为统一资源协同工作
>
> 每台计算机称为一个**节点**node
>
> > **每个结点上也可以安装不同操作系统，只不过在每个结点上面还要再安装集群的操作系统**
>
> :label: 为了性能，通常每一个node会采用smp
> 相当于一台计算机：维护成本高
> 需要有Cluster操作系统

<img src="https://note-image-1307786938.cos.ap-beijing.myqcloud.com/typora/qshell/image-20211203105027919.png" alt="image-20211203105027919" style="zoom: 43%;" /><img src="https://note-image-1307786938.cos.ap-beijing.myqcloud.com/typora/qshell/image-20211203105145265.png" alt="image-20211203105145265" style="zoom: 43%;" />

### 优点

**:one:绝对的可扩展性absolute scalability**：一个集群可以有数十台计算机，每台计算机可能是一个多处理器

:two:**增量可扩展性increment scalability**：可以逐步扩展集群

:three:**高可用性high availability**：具有很好的容错性

:four: **卓越的性价比superior price/performance**

### 缺点

维护工作量大，维护费用较高

为了保证系统的高性能，同时减小维护成本，很多集群采用SMP作为其节点

### 轻量级集群light weight clusters

**被动待机passive standby**：活动的主服务器需要周期性心跳信号，一旦信号停止，备用服务器会立即投入使用，二者不共享磁盘，备用者只提供了功能上的备用

**主动式辅助**

### Cluster 操作系统的设计问题

**故障管理**

**负载均衡**

**并行化计算**

## 17.4 Non-uniform Memory Access System非统一内存访问系统

### 为什么需要NUMA

对于 SMP 系统，随着处理器数量的增加，总线可能会成为性能瓶颈

使用群集时，每个节点都有自己的专用主内存，应用程序看不到较大的全局内存，这会影响实现最大性能

NUMA可以补偿上述限制

<img src="https://note-image-1307786938.cos.ap-beijing.myqcloud.com/typora/qshell/image-20211203111457407.png" alt="image-20211203111457407" style="zoom:67%;" />

对于NUMA中的每一个CPU，可以看到统一的大内存

### 概念

**多个独立计算机通过网络组织成一个计算能力很强的计算机，这些计算机是共享内存的，网络上的每一个计算机都是一个结点**

其中每个处理器都有局部的存储器系统，但所有局部存储器会构成共享的全局存储器

这个存储器逻辑上是统一编址的，其中的每一个结点都可以访问所有的存储器空间

但是对存储器不同地址范围，其物理位置肯定不同，所以真正的存取时间会有所不同

由于对本地存储器的访问比位于其他结点的存储器的访问速度要快，所以这种共享存储器多机系统称为非均匀访问系统NUMA

### 典型组织CC-NUMA

典型的是带有Cache一致维护的NUMA（CC-NUMA）——在各处理器的Cache之间有维护Cache一致性机制的NUMA系统

没有Cache一致性维护的NUMA系统或多或少等同于集群系统

![image-20211227174345953](https://note-image-1307786938.cos.ap-beijing.myqcloud.com/typora/qshell/image-20211227174345953.png)

> 多个独立的结点通过某种通信网络互连
>
> 每个结点都是SMP组织
>
> 每个处理器都有自己的L1和L2 Cache以及存储器，但每个处理器可以访问其他结点的存储器
>
> 每个处理器访问数据时先找自己的1级Cache，如果没有再找局部2级Cache，两个都没有才需要访存，访存时就可能要跨网络访问其他结点，访问其他结点主存

### 优缺点Prons and Cons

**优点**

> 比SMP更高的并行度，无需对软件进行重大更改 
>
> 网络流量有限，因为远程访问不会过多
>
> > L1，L2缓存，本地内存，虚拟内存 
> > 程序具有时间和空间位置 
> > 页面迁移机制 — 移动代理

**缺点**

> 需要一个新的操作系统来支持
>
> 可用性取决于确切的系统